define(["require","exports","Events"],function(n,t,i){function f(n){return("00"+n.toString(16).toUpperCase()).substr(-2)}function l(n){return(n&61440)>>12}function r(n){return(n&3840)>>8}function o(n){return(n&240)>>4}function s(n){var t=[];return t[3]=n&15,n>>=4,t[2]=n&15,n>>=4,t[1]=n&15,n>>=4,t[0]=n&15,t}function h(n,t,i){for(var r=0;r<t;r++)n[r]=i}function e(n,t){h(n,t,0)}var u=i,c=function(){function n(){this.memory=[],this.registers=[],this.keys=[],this.stack=[],this.debug_registers=ko.observableArray(),this.debug_pc=ko.observable(),this.debug_i=ko.observable(),this.debug_sp=ko.observable(),this.debug_stack=ko.observable(),this.debug_next=ko.observable(),this.ClearScreen=new u.Event,this.DrawSprite=new u.Event,this.onWrite=new u.Event,this.onRegisterChange=new u.Event,this.onHalt=new u.Event,this.stopSound=new u.Event,this.startSound=new u.Event,this.instructions=[],this.instructions8=[],this.instructionsF=[],this.loadInstructions(),this.reset()}return n.prototype.reset=function(){e(this.registers,16),e(this.memory,4096),e(this.stack,16),h(this.keys,16,!1),this.I=0,this.PC=512,this.SP=0,this.delay=0,this.sound=0,this.updateDebug(),this.stopSound.raise()},n.prototype.cycle=function(){var n=this.readOpcode(),t=l(n);this.instructions[t](n&4095),this.updateDebug()},n.prototype.tick=function(){this.delay>0&&this.delay--,this.sound>0?this.sound--:this.stopSound.raise()},n.prototype.loadInstructions=function(){var n=this;this.instructions[0]=function(t){switch(t){case 224:n.ClearScreen.raise();break;case 238:n.PC=n.pop();break;default:n.onHalt.raise(t),console.log("Not implemented")}},this.instructions[1]=function(t){n.PC=t},this.instructions[2]=function(t){n.push(n.PC),n.PC=t},this.instructions[3]=function(t){var i=n.registers[r(t)];i===(t&255)&&n.moveNext()},this.instructions[4]=function(t){var i=n.registers[r(t)];i!==(t&255)&&n.moveNext()},this.instructions[5]=function(t){var i=n.registers[r(t)],u=n.registers[o(t)];i===u&&n.moveNext()},this.instructions[6]=function(t){var i=r(t);n.registers[i]=t&255},this.instructions[7]=function(t){var i=r(t);n.registers[i]+=t&255},this.instructions[8]=function(t){var i=s(t);n.instructions8[i[3]](i[1],i[2])},this.instructions8[0]=function(t,i){n.registers[t]=n.registers[i]},this.instructions8[1]=function(t,i){n.registers[t]|=n.registers[i]},this.instructions8[2]=function(t,i){n.registers[t]&=n.registers[i]},this.instructions8[3]=function(t,i){n.registers[t]^=n.registers[i]},this.instructions8[4]=function(t,i){var r=n.registers[t]+n.registers[i];n.registers[15]=r&65536,n.registers[t]=r&65535},this.instructions8[5]=function(t,i){var r=n.registers[t]-n.registers[i];r<0?(r+=65536,n.registers[15]=1):n.registers[15]=0,n.registers[t]=r},this.instructions8[6]=function(t){n.registers[15]=n.registers[t]&1,n.registers[t]>>=1},this.instructions8[7]=function(t,i){var r=n.registers[i]-n.registers[t];r<0?(r+=65536,n.registers[15]=1):n.registers[15]=0,n.registers[t]=r},this.instructions8[14]=function(t){n.registers[15]=n.registers[t]>>15&1,n.registers[t]<<=1},this.instructions[9]=function(t){n.registers[r(t)]!==n.registers[o(t)]&&n.moveNext()},this.instructions[10]=function(t){n.I=t&4095},this.instructions[11]=function(t){n.PC=n.registers[0]+(t&4095)},this.instructions[12]=function(t){var i=Math.random()*65535;n.registers[r(t)]=i&255},this.instructions[13]=function(t){var i=s(t),r=n.registers[i[1]],u=n.registers[i[2]],f=i[3]},this.instructions[14]=function(t){var i=r(t);switch(t&255){case 158:n.keys[i]&&n.moveNext();break;case 161:n.keys[i]||n.moveNext()}},this.instructions[15]=function(t){var i=t&255;n.instructionsF[i](r(t))},this.instructionsF[7]=function(t){n.registers[t]=n.delay},this.instructionsF[10]=function(){throw"FX07 not implemented";},this.instructionsF[21]=function(t){n.delay=n.registers[t]},this.instructionsF[24]=function(t){n.sound=n.registers[t],n.sound>0&&n.startSound.raise()},this.instructionsF[30]=function(t){n.I+=n.registers[t]},this.instructionsF[41]=function(){},this.instructionsF[51]=function(){},this.instructionsF[85]=function(t){for(var r=n.I+t,i=0;n.I<=r;i++,n.I++)n.write(n.I,n.registers[i])},this.instructionsF[101]=function(t){for(var r=n.I+t,i=0;n.I<=r;i++,n.I++)n.registers[i]=n.read(n.I)}},n.prototype.pop=function(){if(this.SP===0)throw"Stack underflow";return this.stack[--this.SP]},n.prototype.push=function(n){if(this.SP===16)throw"Stack overflow";this.stack[this.SP++]=n},n.prototype.readOpcode=function(){var n=this.read(this.PC)<<8|this.read(this.PC+1);return this.moveNext(),n},n.prototype.moveNext=function(){this.PC+=2},n.prototype.read=function(n){if(n>4095)throw"Address ("+n+") is out of range";return this.memory[n]},n.prototype.write=function(n,t){if(n>4095)throw"Address ("+n+") is out of range";this.memory[n]=t},n.prototype.updateDebug=function(){this.debug_registers(this.registers.map(function(n,t){return{index:t.toString(16).toUpperCase(),value:n.toString(16).toUpperCase()}})),this.debug_i(this.I.toString(16).toUpperCase()),this.debug_pc(this.PC.toString(16).toUpperCase()),this.debug_sp(this.SP.toString(16).toUpperCase()),this.debug_next(f(this.memory[this.PC])+f(this.memory[this.PC+1]))},n}();t.Cpu=c,t.displayByte=f})