define(["require","exports","chip8/core"],function(n,t,i){function r(n,t){return{opcode:n<<8|t,nibbles:[n>>4,n&15,t>>4,t&15],bytes:[n,t],NN:t,NNN:(n<<8|t)&4095,X:n&15,Y:t>>4}}function o(){var n=jasmine.createSpyObj("stack",["push","pop","getSP"]);return Object.defineProperty(n,"SP",{get:function(){return this.getSP()}}),n}function s(){var n=jasmine.createSpyObj("memory",["read","write"]);return n.fakeValues=function(t){n.read.andCallFake(function(n){return t[n]})},n}function h(){var n=jasmine.createSpyObj("timers",["setDelay","getDelay","setSound"]);return Object.defineProperty(n,"delay",{set:function(n){this.setDelay(n)},get:function(){return this.getDelay()}}),Object.defineProperty(n,"sound",{set:function(n){this.setSound(n)}}),n}function c(){return jasmine.createSpyObj("screen",["clear","draw"])}function l(){var n=jasmine.createSpyObj("keypad",["read"]),t;return n.fakeKeys=function(t){n.read.andCallFake(function(n){return t[n]})},n.onKeyDown={subscribe:function(n){t=n}},n.fakeKeypress=function(n){t&&t(n)},n}function a(){var n=jasmine.createSpyObj("registers",["read","write"]),t;for(Object.defineProperty(n,"PC",{set:function(n){this.write("PC",n)},get:function(){return this.read("PC")}}),Object.defineProperty(n,"I",{set:function(n){this.write("I",n)},get:function(){return this.read("I")}}),t=0;t<=15;t++)(function(t){Object.defineProperty(n,"v"+t.toString(16).toUpperCase(),{set:function(n){this.write(t,n)},get:function(){return this.read(t)}})})(t);return n.fakeValues=function(t){n.read.andCallFake(function(n){return t[n]})},n}var u=i,f=u.chip8,e;(function(n){(function(){describe("A chip-8 core",function(){var t,n,i,y,e,u,v;beforeEach(function(){n=a(),y=o(),i=s(),e=h(),u=c(),v=l(),t=new f.Core(n,y,i,e,u,v)}),describe("executing the 00E0 - clear screen instruction",function(){beforeEach(function(){t.execute(r(0,224))}),it("should clear the screen",function(){expect(u.clear).toHaveBeenCalled()})}),describe("executing the 00EE - return instruction",function(){describe("with a return address of 0x600",function(){beforeEach(function(){y.pop.andReturn(1536),t.execute(r(0,238))}),it("should set the PC register to 0x600",function(){expect(n.write).toHaveBeenCalledWith("PC",1536)})})}),describe("executing the 1NNN - jmp instruction",function(){describe("with the address 0xF63",function(){beforeEach(function(){t.execute(r(31,99))}),it("should set the PC register to 0xF63",function(){expect(n.write).toHaveBeenCalledWith("PC",3939)})})}),describe("executing the 2NNN - call instruction",function(){describe("with a current PC of 0x210 and a target address of 0x32F",function(){beforeEach(function(){n.fakeValues({PC:528}),t.execute(r(35,47))}),it("should set the PC register to 0x32F",function(){expect(n.write).toHaveBeenCalledWith("PC",815)}),it("should push 0x210 on to the stack",function(){expect(y.push).toHaveBeenCalledWith(528)})})}),describe("executing the 3XNN - skip if equal instruction",function(){describe("with a PC of 0x200 and register 1 set to 0x2f",function(){beforeEach(function(){n.fakeValues({1:47,PC:512}),n.write.reset()}),describe("when checking for a matching value (0x2F)",function(){beforeEach(function(){t.execute(r(49,47))}),it("should set the PC register to 0x202",function(){expect(n.write).toHaveBeenCalledWith("PC",514)})}),describe("when checking for a non matching value (0x11)",function(){beforeEach(function(){t.execute(r(49,17))}),it("should not change the PC register",function(){expect(n.write).not.toHaveBeenCalledWith("PC",514)})})})}),describe("executing the 4XNN - skip if not equal instruction",function(){beforeEach(function(){n.fakeValues({1:47,PC:512}),n.write.reset()}),describe("when checking for a matching value",function(){beforeEach(function(){t.execute(r(65,47))}),it("should not change the PC register",function(){expect(n.write).not.toHaveBeenCalledWith("PC",514)})}),describe("when checking for a non matching value (0x11)",function(){beforeEach(function(){t.execute(r(65,17))}),it("should set the PC register to 0x202",function(){expect(n.write).toHaveBeenCalledWith("PC",514)})})}),describe("executing the 5XY0 - skip if X equal Y instruction",function(){describe("with register values of 1 = 0x2f, 2 = 0x2f, 3 = 0x11 and a PC of 0x200",function(){beforeEach(function(){n.fakeValues({1:47,2:47,3:17,PC:512}),n.write.reset()}),describe("when checking two matching registers (1 and 2)",function(){beforeEach(function(){t.execute(r(81,32))}),it("should set the PC register to 0x202",function(){expect(n.write).toHaveBeenCalledWith("PC",514)})}),describe("when checking two non matching registers (1 and 3)",function(){beforeEach(function(){t.execute(r(81,48))}),it("should not change the PC register",function(){expect(n.write).not.toHaveBeenCalledWith("PC",514)})})})}),describe("executing the 6XNN - set X to NN instruction",function(){describe("with a value of 0xF0 and a target of register 1",function(){beforeEach(function(){t.execute(r(97,240))}),it("should set register 1 to 0xF0",function(){expect(n.write).toHaveBeenCalledWith(1,240)})})}),describe("executing the 7XNN - add NN to X instruction",function(){describe("with the register values 1 = 0x20, 2 = 0x5",function(){beforeEach(function(){n.fakeValues({1:32,2:5}),n.write.reset()}),describe("when adding 0x25 to register 1",function(){beforeEach(function(){t.execute(r(113,37))}),it("should set register 1 to 0x45",function(){expect(n.write).toHaveBeenCalledWith(1,69)})}),describe("when adding 0x3 to register 2",function(){beforeEach(function(){t.execute(r(114,3))}),it("should set register 2 to 0x8",function(){expect(n.write).toHaveBeenCalledWith(2,8)})}),describe("when adding 0xFF to register 1",function(){beforeEach(function(){t.execute(r(113,255))}),it("should wrap around and set regist 1 to 0x1F",function(){expect(n.write).toHaveBeenCalledWith(1,31)})})})}),describe("executing the 8XY0 - set X to Y instruction",function(){describe("with register 5 set to 0x6A",function(){beforeEach(function(){n.fakeValues({5:106})}),describe("with a source of register 5 and a target of register 1",function(){beforeEach(function(){t.execute(r(129,80))}),it("should set register 1 to 0x6A",function(){expect(n.write).toHaveBeenCalledWith(1,106)})})})}),describe("executing the 8XY1 - set X to X or Y instruction",function(){describe("with register values of 1 = 0x0F, 3 = 0x70",function(){beforeEach(function(){n.fakeValues({1:15,3:112})}),describe("with target registers 1 and 3",function(){beforeEach(function(){t.execute(r(129,49))}),it("should set register 1 to 0x7F",function(){expect(n.write).toHaveBeenCalledWith(1,127)})})})}),it("should execute the 8XY2 - set X to Z and Y instruction",function(){n.fakeValues({1:195,2:15}),t.execute(r(129,34)),expect(n.write).toHaveBeenCalledWith(1,3)}),it("should execute the 8XY3 - set X to Z xor Y instruction",function(){n.fakeValues({1:108,2:85}),t.execute(r(129,35)),expect(n.write).toHaveBeenCalledWith(1,57)}),it("should execute the 8XY4 - add Y to X with carry instruction",function(){n.fakeValues({1:1,2:85,3:255}),t.execute(r(129,36)),expect(n.write).toHaveBeenCalledWith(15,0),expect(n.write).toHaveBeenCalledWith(1,86),n.write.reset(),t.execute(r(129,52)),expect(n.write).toHaveBeenCalledWith(15,1),expect(n.write).toHaveBeenCalledWith(1,0)}),it("should execute the 8XY5 - sub Y from X with borrow instruction",function(){n.fakeValues({1:16,2:5,3:32}),t.execute(r(129,37)),expect(n.write).toHaveBeenCalledWith(15,1),expect(n.write).toHaveBeenCalledWith(1,11),n.write.reset(),t.execute(r(129,53)),expect(n.write).toHaveBeenCalledWith(15,0),expect(n.write).toHaveBeenCalledWith(1,240)}),describe("executing the 8XY6 - shift Y right by 1 with carry and store in X instruction",function(){beforeEach(function(){n.write.reset()}),describe("with register 1 set to 0x04",function(){beforeEach(function(){n.fakeValues({1:4})}),describe("when shifting register 1 with a target of register 5",function(){beforeEach(function(){t.execute(r(133,22))}),it("should set register 5 to 0x02",function(){expect(n.write).toHaveBeenCalledWith(5,2)}),it("should set register F to previous LSB (0)",function(){expect(n.write).toHaveBeenCalledWith(15,0)})})}),describe("with register 2 set to 0x05",function(){beforeEach(function(){n.fakeValues({2:5})}),describe("when shifting register 2 with a target of register 4",function(){beforeEach(function(){t.execute(r(132,38))}),it("should set register 4 to 0x02",function(){expect(n.write).toHaveBeenCalledWith(4,2)}),it("should set register F to previous LSB (1)",function(){expect(n.write).toHaveBeenCalledWith(15,1)})})})}),it("should execute the 8XY7 - sub X from Y storing in X with borrow instruction",function(){n.fakeValues({1:16,2:5,3:32}),t.execute(r(130,23)),expect(n.write).toHaveBeenCalledWith(15,1),expect(n.write).toHaveBeenCalledWith(2,11),n.write.reset(),t.execute(r(131,23)),expect(n.write).toHaveBeenCalledWith(15,0),expect(n.write).toHaveBeenCalledWith(3,240)}),describe("executing the 8XYE - shift Y left by 1 with carry and store in X instruction",function(){beforeEach(function(){n.write.reset()}),describe("with register 1 set to 0xF0",function(){beforeEach(function(){n.fakeValues({1:240})}),describe("when shifting register 1 with a target of register 5",function(){beforeEach(function(){t.execute(r(133,30))}),it("should set register 5 to 0x02",function(){expect(n.write).toHaveBeenCalledWith(5,224)}),it("should set register F to previous MSB (1)",function(){expect(n.write).toHaveBeenCalledWith(15,1)})})}),describe("with register 2 set to 0x04",function(){beforeEach(function(){n.fakeValues({2:4})}),describe("when shifting register 2 with a target of register 4",function(){beforeEach(function(){t.execute(r(132,46))}),it("should set register 4 to 0x08",function(){expect(n.write).toHaveBeenCalledWith(4,8)}),it("should set register F to previous MSB (0)",function(){expect(n.write).toHaveBeenCalledWith(15,0)})})})}),it("should execute the 9XY0 - skip if X not equal Y instruction",function(){n.fakeValues({1:47,2:47,3:113,PC:512}),t.execute(r(145,32)),expect(n.write).not.toHaveBeenCalledWith("PC",514),n.write.reset(),t.execute(r(145,48)),expect(n.write).toHaveBeenCalledWith("PC",514)}),it("should execute the ANNN - set I to NNN instruction",function(){var i=r(161,253);t.execute(i),expect(n.write).toHaveBeenCalledWith("I",509)}),it("should execute the BNNN - jump to NNN + v0 instruction",function(){n.fakeValues({0:255});var i=r(191,255);t.execute(i),expect(n.write).toHaveBeenCalledWith("PC",4350)}),it("should execute the CXNN - set X to random AND NN instruction",function(){var i=Math.random;Math.random=jasmine.createSpy("random").andReturn(1/255*249),t.execute(r(193,255)),expect(n.write).toHaveBeenCalledWith(1,249),n.write.reset(),t.execute(r(193,15)),expect(n.write).toHaveBeenCalledWith(1,9),Math.random=i}),it("should execute the DXYN - draw sprite instruction",function(){i.fakeValues({1792:240,1793:144,1794:144,1795:144,1796:240}),n.fakeValues({1:10,2:25,I:1792}),u.draw.andReturn(1),t.execute(r(209,37)),expect(u.draw).toHaveBeenCalledWith(10,25,[240,144,144,144,240]),expect(n.write).toHaveBeenCalledWith(15,1),n.write.reset(),u.draw.andReturn(0),t.execute(r(209,37)),expect(n.write).toHaveBeenCalledWith(15,0)}),it("should execute the EX9E - skip if key X is pressed instruction",function(){n.fakeValues({1:0,5:4,PC:512}),v.fakeKeys({0:1,4:0}),t.execute(r(225,158)),expect(n.write).toHaveBeenCalledWith("PC",514),n.write.reset(),t.execute(r(229,158)),expect(n.write).not.toHaveBeenCalled()}),it("should execute the EXA1 - skip if key X is not pressed instruction",function(){n.fakeValues({1:8,5:3,PC:512}),v.fakeKeys({3:1,8:0}),t.execute(r(225,161)),expect(n.write).toHaveBeenCalledWith("PC",514),n.write.reset(),t.execute(r(229,161)),expect(n.write).not.toHaveBeenCalled()}),it("should execute the FX07 - set X to delay timer instruction",function(){e.getDelay.andReturn(213),t.execute(r(243,7)),expect(n.write).toHaveBeenCalledWith(3,213)}),it("should execute the FX0A - await keypress and store in X instruction",function(){t.execute(r(243,10)),expect(t.halted).toBe(!0),expect(n.write).not.toHaveBeenCalledWith(3,10),v.fakeKeypress(10),expect(t.halted).toBe(!1),expect(n.write).toHaveBeenCalledWith(3,10)}),it("should execute the FX15 - set delay timer to X instruction",function(){n.fakeValues({1:246}),t.execute(r(241,21)),expect(e.setDelay).toHaveBeenCalledWith(246)}),it("should execute the FX18 - set sound timer to X instruction",function(){n.fakeValues({7:43}),t.execute(r(247,24)),expect(e.setSound).toHaveBeenCalledWith(43)}),it("should execute the FX1E - Add vX to I instruction",function(){n.fakeValues({1:8,2:255,I:3841}),t.execute(r(241,30)),expect(n.write).toHaveBeenCalledWith("I",3849),expect(n.write).toHaveBeenCalledWith(15,0),n.write.reset(),t.execute(r(242,30)),expect(n.write).toHaveBeenCalledWith("I",0),expect(n.write).toHaveBeenCalledWith(15,1)}),it("should execute the FX29 - load address of font char X into I instruction",function(){n.fakeValues({1:3,2:1}),t.execute(r(241,41)),expect(n.write).toHaveBeenCalledWith("I",15),n.write.reset(),t.execute(r(242,41)),expect(n.write).toHaveBeenCalledWith("I",5)}),it("should execute the FX33 - store BCD of X in memory at I instruction",function(){n.fakeValues({1:240,2:2,I:1792}),t.execute(r(241,51)),expect(i.write).toHaveBeenCalledWith(1792,2),expect(i.write).toHaveBeenCalledWith(1793,4),expect(i.write).toHaveBeenCalledWith(1794,0),i.write.reset(),t.execute(r(242,51)),expect(i.write).toHaveBeenCalledWith(1792,0),expect(i.write).toHaveBeenCalledWith(1793,0),expect(i.write).toHaveBeenCalledWith(1794,2)}),describe("executing the FX55 - store v0 to vX in memory at I instruction",function(){describe("with registers 0 to 4 set to [0, 10, 20, 30, 40]",function(){beforeEach(function(){n.fakeValues({0:0,1:10,2:20,3:30,4:40,I:1792})}),describe("with a length of 4 and a target address of 0x700",function(){beforeEach(function(){t.execute(r(244,85))}),it("should write 0 to memory at 0x700",function(){expect(i.write).toHaveBeenCalledWith(1792,0)}),it("should write 10 to memory at 0x701",function(){expect(i.write).toHaveBeenCalledWith(1793,10)}),it("should write 20 to memory at 0x702",function(){expect(i.write).toHaveBeenCalledWith(1794,20)}),it("should write 30 to memory at 0x703",function(){expect(i.write).toHaveBeenCalledWith(1795,30)}),it("should write 40 to memory at 0x704",function(){expect(i.write).toHaveBeenCalledWith(1796,40)}),it("set register I to 0x705",function(){expect(n.write).toHaveBeenCalledWith("I",1797)})})})}),describe("executing the FX65 - load v0 to vX from memory at I instruction",function(){describe("with memory 0x700 to 0x704 set to [0,10,20,30,40]",function(){beforeEach(function(){i.fakeValues({1792:0,1793:10,1794:20,1795:30,1796:40})}),describe("with a source address of 0x700 and a length of 4",function(){beforeEach(function(){n.fakeValues({I:1792}),t.execute(r(244,101))}),it("should set register 0 to 0",function(){expect(n.write).toHaveBeenCalledWith(0,0)}),it("should set register 1 to 10",function(){expect(n.write).toHaveBeenCalledWith(1,10)}),it("should set register 2 to 20",function(){expect(n.write).toHaveBeenCalledWith(2,20)}),it("should set register 3 to 30",function(){expect(n.write).toHaveBeenCalledWith(3,30)}),it("should set register 4 to 40",function(){expect(n.write).toHaveBeenCalledWith(4,40)}),it("should set register I to 0x705",function(){expect(n.write).toHaveBeenCalledWith("I",1797)})})})})})})(n.spec||(n.spec={}));var t=n.spec})(t.chip8||(t.chip8={})),e=t.chip8})