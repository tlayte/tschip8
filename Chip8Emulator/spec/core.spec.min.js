define(["require","exports","chip8/core"],function(n,t,i){function r(n,t){return{opcode:n<<8|t,nibbles:[n>>4,n&15,t>>4,t&15],bytes:[n,t],NN:t,NNN:(n<<8|t)&4095,X:n&15,Y:t>>4}}function o(){var n=jasmine.createSpyObj("stack",["push","pop","getSP"]);return Object.defineProperty(n,"SP",{get:function(){return this.getSP()}}),n}function s(){var n=jasmine.createSpyObj("memory",["read","write"]);return n.fakeValues=function(t){n.read.andCallFake(function(n){return t[n]})},n}function h(){var n=jasmine.createSpyObj("timers",["setDelay","getDelay","setSound"]);return Object.defineProperty(n,"delay",{set:function(n){this.setDelay(n)},get:function(){return this.getDelay()}}),Object.defineProperty(n,"sound",{set:function(n){this.setSound(n)}}),n}function c(){return jasmine.createSpyObj("screen",["clear","draw"])}function l(){var n=jasmine.createSpyObj("registers",["read","write"]),t;for(Object.defineProperty(n,"PC",{set:function(n){this.write("PC",n)},get:function(){return this.read("PC")}}),Object.defineProperty(n,"I",{set:function(n){this.write("I",n)},get:function(){return this.read("I")}}),t=0;t<=15;t++)(function(t){Object.defineProperty(n,"v"+t.toString(16).toUpperCase(),{set:function(n){this.write(t,n)},get:function(){return this.read(t)}})})(t);return n.fakeValues=function(t){n.read.andCallFake(function(n){return t[n]})},n}var u=i,f=u.chip8,e;(function(n){(function(){describe("A chip-8 core",function(){var t,n,i,e,u,a;beforeEach(function(){n=l(),e=o(),i=s(),u=h(),a=c(),t=new f.Core(n,e,i,u,a)}),it("should execute the 00E0 - clear screen instruction",function(){t.execute(r(0,224)),expect(a.clear).toHaveBeenCalled()}),it("should execute the 00EE - return instruction",function(){e.pop.andReturn(1536),t.execute(r(0,238)),expect(n.write).toHaveBeenCalledWith("PC",1536)}),it("should execute the 1NNN - jmp instruction",function(){t.execute(r(31,99)),expect(n.write).toHaveBeenCalledWith("PC",3939)}),it("should execute the 2NNN - call instruction",function(){n.fakeValues({PC:528}),t.execute(r(35,47)),expect(n.write).toHaveBeenCalledWith("PC",815),expect(e.push).toHaveBeenCalledWith(528)}),it("should execute the 3XNN - skip if equal instruction",function(){n.fakeValues({1:47,PC:512}),t.execute(r(49,47)),expect(n.write).toHaveBeenCalledWith("PC",514),n.write.reset(),t.execute(r(49,17)),expect(n.write).not.toHaveBeenCalledWith("PC",514)}),it("should execute the 4XNN - skip if not equal instruction",function(){n.fakeValues({1:47,PC:512}),t.execute(r(65,47)),expect(n.write).not.toHaveBeenCalledWith("PC",514),n.write.reset(),t.execute(r(65,17)),expect(n.write).toHaveBeenCalledWith("PC",514)}),it("should execute the 5XY0 - skip if X equal Y instruction",function(){n.fakeValues({1:47,2:47,3:17,PC:512}),t.execute(r(81,32)),expect(n.write).toHaveBeenCalledWith("PC",514),n.write.reset(),t.execute(r(81,48)),expect(n.write).not.toHaveBeenCalledWith("PC",514)}),it("should execute the 6XNN - set X to NN instruction",function(){t.execute(r(97,240)),expect(n.write).toHaveBeenCalledWith(1,240)}),it("should execute the 7XNN - add NN to X instruction",function(){n.fakeValues({1:32}),t.execute(r(113,37)),expect(n.write).toHaveBeenCalledWith(1,69),n.write.reset(),t.execute(r(113,255)),expect(n.write).toHaveBeenCalledWith(1,31)}),it("should execute the 8XY0 - set X to Y instruction",function(){n.fakeValues({5:106}),t.execute(r(129,80)),expect(n.write).toHaveBeenCalledWith(1,106)}),it("should execute the 8XY1 - set X to Z or Y instruction",function(){n.fakeValues({1:15,3:112}),t.execute(r(129,49)),expect(n.write).toHaveBeenCalledWith(1,127)}),it("should execute the 8XY2 - set X to Z and Y instruction",function(){n.fakeValues({1:195,2:15}),t.execute(r(129,34)),expect(n.write).toHaveBeenCalledWith(1,3)}),it("should execute the 8XY3 - set X to Z xor Y instruction",function(){n.fakeValues({1:108,2:85}),t.execute(r(129,35)),expect(n.write).toHaveBeenCalledWith(1,57)}),it("should execute the 8XY4 - add Y to X with carry instruction",function(){n.fakeValues({1:1,2:85,3:255}),t.execute(r(129,36)),expect(n.write).toHaveBeenCalledWith(15,0),expect(n.write).toHaveBeenCalledWith(1,86),n.write.reset(),t.execute(r(129,52)),expect(n.write).toHaveBeenCalledWith(15,1),expect(n.write).toHaveBeenCalledWith(1,0)}),it("should execute the 8XY5 - sub Y from X with borrow instruction",function(){n.fakeValues({1:16,2:5,3:32}),t.execute(r(129,37)),expect(n.write).toHaveBeenCalledWith(15,1),expect(n.write).toHaveBeenCalledWith(1,11),n.write.reset(),t.execute(r(129,53)),expect(n.write).toHaveBeenCalledWith(15,0),expect(n.write).toHaveBeenCalledWith(1,240)}),it("should execute the 8XY6 - shift X right by 1 with carry instruction",function(){n.fakeValues({1:4,2:5}),t.execute(r(129,6)),expect(n.write).toHaveBeenCalledWith(15,0),expect(n.write).toHaveBeenCalledWith(1,2),n.write.reset(),t.execute(r(130,6)),expect(n.write).toHaveBeenCalledWith(15,1),expect(n.write).toHaveBeenCalledWith(2,2)}),it("should execute the 8XY7 - sub X from Y storing in X with borrow instruction",function(){n.fakeValues({1:16,2:5,3:32}),t.execute(r(130,23)),expect(n.write).toHaveBeenCalledWith(15,1),expect(n.write).toHaveBeenCalledWith(2,11),n.write.reset(),t.execute(r(131,23)),expect(n.write).toHaveBeenCalledWith(15,0),expect(n.write).toHaveBeenCalledWith(3,240)}),it("should execute the 8XYE - shift X left by 1 with carry instruction",function(){n.fakeValues({1:240,2:4}),t.execute(r(129,14)),expect(n.write).toHaveBeenCalledWith(15,1),expect(n.write).toHaveBeenCalledWith(1,224),n.write.reset(),t.execute(r(130,14)),expect(n.write).toHaveBeenCalledWith(15,0),expect(n.write).toHaveBeenCalledWith(2,8)}),it("should execute the 9XY0 - skip if X not equal Y instruction",function(){n.fakeValues({1:47,2:47,3:113,PC:512}),t.execute(r(145,32)),expect(n.write).not.toHaveBeenCalledWith("PC",514),n.write.reset(),t.execute(r(145,48)),expect(n.write).toHaveBeenCalledWith("PC",514)}),it("should execute the ANNN - set I to NNN instruction",function(){var i=r(161,253);t.execute(i),expect(n.write).toHaveBeenCalledWith("I",509)}),it("should execute the BNNN - jump to NNN + v0 instruction",function(){n.fakeValues({0:255});var i=r(191,255);t.execute(i),expect(n.write).toHaveBeenCalledWith("PC",4350)}),it("should execute the CXNN - set X to random AND NN instruction",function(){var i=Math.random;Math.random=jasmine.createSpy("random").andReturn(1/255*249),t.execute(r(193,255)),expect(n.write).toHaveBeenCalledWith(1,249),n.write.reset(),t.execute(r(193,15)),expect(n.write).toHaveBeenCalledWith(1,9),Math.random=i}),it("should execute the DXYN - draw sprite instruction",function(){i.fakeValues({1792:240,1793:144,1794:144,1795:144,1796:240}),n.fakeValues({1:10,2:25,I:1792}),t.execute(r(209,37)),expect(a.draw).toHaveBeenCalledWith(10,25,[240,144,144,144,240])}),it("should execute the FX07 - set X to delay timer instruction",function(){u.getDelay.andReturn(213),t.execute(r(243,7)),expect(n.write).toHaveBeenCalledWith(3,213)}),it("should execute the FX15 - set delay timer to X instruction",function(){n.fakeValues({1:246}),t.execute(r(241,21)),expect(u.setDelay).toHaveBeenCalledWith(246)}),it("should execute the FX18 - set sound timer to X instruction",function(){n.fakeValues({7:43}),t.execute(r(247,24)),expect(u.setSound).toHaveBeenCalledWith(43)}),it("should execute the FX1E - Add vX to I instruction",function(){n.fakeValues({1:8,2:255,I:3841}),t.execute(r(241,30)),expect(n.write).toHaveBeenCalledWith("I",3849),expect(n.write).toHaveBeenCalledWith(15,0),n.write.reset(),t.execute(r(242,30)),expect(n.write).toHaveBeenCalledWith("I",0),expect(n.write).toHaveBeenCalledWith(15,1)}),it("should execute the FX29 - load address of font char X into I instruction",function(){n.fakeValues({1:3,2:1}),t.execute(r(241,41)),expect(n.write).toHaveBeenCalledWith("I",15),n.write.reset(),t.execute(r(242,41)),expect(n.write).toHaveBeenCalledWith("I",5)}),it("should execute the FX33 - store BCD of X in memory at I instruction",function(){n.fakeValues({1:240,2:2,I:1792}),t.execute(r(241,51)),expect(i.write).toHaveBeenCalledWith(1792,2),expect(i.write).toHaveBeenCalledWith(1793,4),expect(i.write).toHaveBeenCalledWith(1794,0),i.write.reset(),t.execute(r(242,51)),expect(i.write).toHaveBeenCalledWith(1792,0),expect(i.write).toHaveBeenCalledWith(1793,0),expect(i.write).toHaveBeenCalledWith(1794,2)}),it("should execute the FX55 - store v0 to v5 in memory at I instruction",function(){n.fakeValues({0:0,1:10,2:20,3:30,4:40,I:1792}),t.execute(r(244,85)),expect(n.write).toHaveBeenCalledWith("I",1797),expect(i.write).toHaveBeenCalledWith(1792,0),expect(i.write).toHaveBeenCalledWith(1793,10),expect(i.write).toHaveBeenCalledWith(1794,20),expect(i.write).toHaveBeenCalledWith(1795,30),expect(i.write).toHaveBeenCalledWith(1796,40)}),it("should execute the FX65 - load v0 to v5 from memory at I instruction",function(){i.fakeValues({1792:0,1793:10,1794:20,1795:30,1796:40}),n.fakeValues({I:1792}),t.execute(r(244,101)),expect(n.write).toHaveBeenCalledWith("I",1797),expect(n.write).toHaveBeenCalledWith(0,0),expect(n.write).toHaveBeenCalledWith(1,10),expect(n.write).toHaveBeenCalledWith(2,20),expect(n.write).toHaveBeenCalledWith(3,30),expect(n.write).toHaveBeenCalledWith(4,40)})})})(n.spec||(n.spec={}));var t=n.spec})(t.chip8||(t.chip8={})),e=t.chip8})